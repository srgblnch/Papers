%constants
\def\blockdist{1.75}
\def\machinedist{5}
\def\machinegap{0.6}
\def\networkLine{\blockdist-2}

%styles
\tikzstyle{software}=[draw, fill=blue!20, text width=5em, 
    text centered, minimum height=2.5em]
\tikzstyle{middleware} = [software, text width=6em, fill=yellow!20, 
    minimum width=\machinedist*9em, rounded corners]

%layers
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

\begin{tikzpicture}

\node (LocalOS_A) at (-\machinedist,-\blockdist) [software] {Local OS};
\node (LocalOS_B) at (0,-\blockdist) [software] {Local OS};
\node (LocalOS_C) at (\machinedist,-\blockdist) [software] {Local OS};

\node (Tango) at (0,0) [middleware] {Tango Middleware};

\node (tangodb) at (-\machinedist,\blockdist) [software] {tango-db};
\node (agent) at (0,\blockdist) [software] {Agent};
\node (gui) at (\machinedist,\blockdist) [software] {User Interface};

\begin{pgfonlayer}{background}
    \path (tangodb.north west)+(-\machinegap,\machinegap) node (a) {};
    \path (LocalOS_A.south east)+(\machinegap,-\machinegap) node (b) {};
    \path[fill=blue!10,rounded corners, draw=black!50, dashed]
            (a) rectangle (b);
   \path (tangodb.north)+(0,\machinegap+.5) node (macA) {Machine A};

    \path (agent.north west)+(-\machinegap,\machinegap) node (a) {};
    \path (LocalOS_B.south east)+(\machinegap,-\machinegap) node (b) {};
    \path[fill=blue!10,rounded corners, draw=black!50, dashed]
            (a) rectangle (b);
   \path (agent.north)+(0,\machinegap+.5) node (macB) {Machine B};


    \path (gui.north west)+(-\machinegap,\machinegap) node (a) {};
    \path (LocalOS_C.south east)+(\machinegap,-\machinegap) node (b) {};
    \path[fill=blue!10,rounded corners, draw=black!50, dashed]
            (a) rectangle (b);
   \path (gui.north)+(0,\machinegap+.5) node (macC) {Machine C};

    \path (tangodb.north west)+(-\machinegap/2,\machinegap/2) node (a) {};
    \path (gui.south east)+(\machinegap/2,-\machinegap) node (b) {};
    \path[fill=blue!5,rounded corners, draw=black!50, dashed]
            (a) rectangle (b);
   \path (agent.south)+(0,-\machinegap+.2) node (app) {Distributed Application};

\end{pgfonlayer}

\draw[line width=5] (-\machinedist*1.3,-\networkLine) -- (\machinedist*1.3,-\networkLine);

\path (LocalOS_A.south)+(0,-\blockdist) node (c) {};
\draw[line width=5] (LocalOS_A.south) -- (c);

\path (LocalOS_B.south)+(0,-\blockdist) node (c) {};
\draw[line width=5] (LocalOS_B.south) -- (c);

\path (LocalOS_C.south)+(0,-\blockdist) node (c) {};
\draw[line width=5] (LocalOS_C.south) -- (c);

\end{tikzpicture}